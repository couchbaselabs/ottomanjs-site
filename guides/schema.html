<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Schema | Ottoman.js</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Ottoman is a ODM built for Couchbase and Node.js. ">
    
    <link rel="preload" href="/assets/css/0.styles.058b88e7.css" as="style"><link rel="preload" href="/assets/js/app.4ce8c23d.js" as="script"><link rel="preload" href="/assets/js/2.3ccdf2b1.js" as="script"><link rel="preload" href="/assets/js/7.1fd01169.js" as="script"><link rel="prefetch" href="/assets/js/10.0939eddc.js"><link rel="prefetch" href="/assets/js/11.d724733c.js"><link rel="prefetch" href="/assets/js/12.0cfb704e.js"><link rel="prefetch" href="/assets/js/13.fdb36789.js"><link rel="prefetch" href="/assets/js/14.666ee4cd.js"><link rel="prefetch" href="/assets/js/15.0080644e.js"><link rel="prefetch" href="/assets/js/16.2fd27d94.js"><link rel="prefetch" href="/assets/js/17.df08fd8f.js"><link rel="prefetch" href="/assets/js/18.840a9418.js"><link rel="prefetch" href="/assets/js/19.cf5e8b3c.js"><link rel="prefetch" href="/assets/js/20.179dd4f7.js"><link rel="prefetch" href="/assets/js/21.54c7948d.js"><link rel="prefetch" href="/assets/js/22.16dfe7dd.js"><link rel="prefetch" href="/assets/js/23.b3cbe50f.js"><link rel="prefetch" href="/assets/js/24.fdd0a248.js"><link rel="prefetch" href="/assets/js/25.0d6e3762.js"><link rel="prefetch" href="/assets/js/26.a2b0cace.js"><link rel="prefetch" href="/assets/js/27.d811d136.js"><link rel="prefetch" href="/assets/js/28.7695b512.js"><link rel="prefetch" href="/assets/js/29.ea15028b.js"><link rel="prefetch" href="/assets/js/3.d3b68f08.js"><link rel="prefetch" href="/assets/js/30.3ffc63a7.js"><link rel="prefetch" href="/assets/js/31.e357f825.js"><link rel="prefetch" href="/assets/js/32.5a2cbcfb.js"><link rel="prefetch" href="/assets/js/33.b73d8c87.js"><link rel="prefetch" href="/assets/js/34.32b2fb9c.js"><link rel="prefetch" href="/assets/js/35.a9c786ae.js"><link rel="prefetch" href="/assets/js/36.dc7586df.js"><link rel="prefetch" href="/assets/js/37.ae22f32d.js"><link rel="prefetch" href="/assets/js/38.5860a1b1.js"><link rel="prefetch" href="/assets/js/39.740aaf14.js"><link rel="prefetch" href="/assets/js/4.2a7ae6ef.js"><link rel="prefetch" href="/assets/js/40.3f5c3173.js"><link rel="prefetch" href="/assets/js/41.352ebf57.js"><link rel="prefetch" href="/assets/js/42.497666e1.js"><link rel="prefetch" href="/assets/js/43.3f4f4760.js"><link rel="prefetch" href="/assets/js/44.40089da5.js"><link rel="prefetch" href="/assets/js/45.8b326663.js"><link rel="prefetch" href="/assets/js/46.ea79238f.js"><link rel="prefetch" href="/assets/js/47.a86f9b4b.js"><link rel="prefetch" href="/assets/js/48.331076c7.js"><link rel="prefetch" href="/assets/js/49.df848476.js"><link rel="prefetch" href="/assets/js/5.4df73630.js"><link rel="prefetch" href="/assets/js/50.8aa201e4.js"><link rel="prefetch" href="/assets/js/51.6f1312a8.js"><link rel="prefetch" href="/assets/js/52.68f45bb0.js"><link rel="prefetch" href="/assets/js/53.4ee7eec7.js"><link rel="prefetch" href="/assets/js/54.c60a07d3.js"><link rel="prefetch" href="/assets/js/55.a019a425.js"><link rel="prefetch" href="/assets/js/56.baaf287d.js"><link rel="prefetch" href="/assets/js/57.2c78c374.js"><link rel="prefetch" href="/assets/js/58.cc4f7d72.js"><link rel="prefetch" href="/assets/js/59.642435af.js"><link rel="prefetch" href="/assets/js/6.ffe0b917.js"><link rel="prefetch" href="/assets/js/60.68995bce.js"><link rel="prefetch" href="/assets/js/61.3355351c.js"><link rel="prefetch" href="/assets/js/62.2a46d89b.js"><link rel="prefetch" href="/assets/js/63.069e1728.js"><link rel="prefetch" href="/assets/js/64.a01f213a.js"><link rel="prefetch" href="/assets/js/65.7ccc4c05.js"><link rel="prefetch" href="/assets/js/66.7e4f06a2.js"><link rel="prefetch" href="/assets/js/67.b15988e1.js"><link rel="prefetch" href="/assets/js/68.57370c5c.js"><link rel="prefetch" href="/assets/js/69.da7fd603.js"><link rel="prefetch" href="/assets/js/70.50dc819f.js"><link rel="prefetch" href="/assets/js/71.fc298596.js"><link rel="prefetch" href="/assets/js/72.df1e417b.js"><link rel="prefetch" href="/assets/js/73.961d5831.js"><link rel="prefetch" href="/assets/js/74.0be06f4c.js"><link rel="prefetch" href="/assets/js/75.a93d2143.js"><link rel="prefetch" href="/assets/js/76.ef41479a.js"><link rel="prefetch" href="/assets/js/77.3aa6ca07.js"><link rel="prefetch" href="/assets/js/78.68520552.js"><link rel="prefetch" href="/assets/js/79.7535adbc.js"><link rel="prefetch" href="/assets/js/8.423bb662.js"><link rel="prefetch" href="/assets/js/80.a162a59f.js"><link rel="prefetch" href="/assets/js/81.893a8015.js"><link rel="prefetch" href="/assets/js/82.6bc60732.js"><link rel="prefetch" href="/assets/js/83.69684411.js"><link rel="prefetch" href="/assets/js/9.6ad56039.js">
    <link rel="stylesheet" href="/assets/css/0.styles.058b88e7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Ottoman.js</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guides/quick-start.html" class="nav-link">
  Quick Start
</a></div><div class="nav-item"><a href="/guides/ottoman.html" class="nav-link">
  Ottoman
</a></div><div class="nav-item"><a href="/guides/schema.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Schema
</a></div><div class="nav-item"><a href="/guides/model.html" class="nav-link">
  Model
</a></div><div class="nav-item"><a href="/guides/document.html" class="nav-link">
  Document
</a></div><div class="nav-item"><a href="/guides/query-builder.html" class="nav-link">
  Query Builder
</a></div><div class="nav-item"><a href="/guides/first-app.html" class="nav-link">
  Example
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="API" class="dropdown-title"><span class="title">API</span> <span class="arrow down"></span></button> <button type="button" aria-label="API" class="mobile-dropdown-title"><span class="title">API</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/classes/ottoman.html" class="nav-link">
  Ottoman
</a></li><li class="dropdown-item"><!----> <a href="/classes/schema.html" class="nav-link">
  Schema
</a></li><li class="dropdown-item"><!----> <a href="/classes/model.html" class="nav-link">
  Model
</a></li><li class="dropdown-item"><!----> <a href="/classes/document.html" class="nav-link">
  Document
</a></li><li class="dropdown-item"><!----> <a href="/classes/query.html" class="nav-link">
  Query Builder
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/couchbaselabs/node-ottoman" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guides/quick-start.html" class="nav-link">
  Quick Start
</a></div><div class="nav-item"><a href="/guides/ottoman.html" class="nav-link">
  Ottoman
</a></div><div class="nav-item"><a href="/guides/schema.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Schema
</a></div><div class="nav-item"><a href="/guides/model.html" class="nav-link">
  Model
</a></div><div class="nav-item"><a href="/guides/document.html" class="nav-link">
  Document
</a></div><div class="nav-item"><a href="/guides/query-builder.html" class="nav-link">
  Query Builder
</a></div><div class="nav-item"><a href="/guides/first-app.html" class="nav-link">
  Example
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="API" class="dropdown-title"><span class="title">API</span> <span class="arrow down"></span></button> <button type="button" aria-label="API" class="mobile-dropdown-title"><span class="title">API</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/classes/ottoman.html" class="nav-link">
  Ottoman
</a></li><li class="dropdown-item"><!----> <a href="/classes/schema.html" class="nav-link">
  Schema
</a></li><li class="dropdown-item"><!----> <a href="/classes/model.html" class="nav-link">
  Model
</a></li><li class="dropdown-item"><!----> <a href="/classes/document.html" class="nav-link">
  Document
</a></li><li class="dropdown-item"><!----> <a href="/classes/query.html" class="nav-link">
  Query Builder
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/couchbaselabs/node-ottoman" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Schema</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guides/schema.html#defining-your-schema" class="sidebar-link">Defining your schema</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/guides/schema.html#allowed-schematypes-are" class="sidebar-link">Allowed SchemaTypes are:</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/guides/schema.html#creating-a-model" class="sidebar-link">Creating a model</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/guides/schema.html#indexes" class="sidebar-link">Indexes</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/guides/schema.html#index-types" class="sidebar-link">Index Types</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guides/schema.html#refdoc" class="sidebar-link">refdoc</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#view" class="sidebar-link">view</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#n1ql" class="sidebar-link">n1ql</a></li></ul></li><li><a href="/guides/schema.html#instance-methods" class="sidebar-link">Instance methods</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/guides/schema.html#statics" class="sidebar-link">Statics</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/guides/schema.html#hooks" class="sidebar-link">Hooks</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guides/schema.html#the-available-hooks-are" class="sidebar-link">The available hooks are:</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#register-hooks-with-pre-function" class="sidebar-link">Register hooks with pre function</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#hooks-use-cases" class="sidebar-link">Hooks Use Cases</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#errors-in-pre-hooks" class="sidebar-link">Errors in Pre Hooks</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#post-hooks" class="sidebar-link">Post Hooks</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#define-hooks-before-compiling-models" class="sidebar-link">Define Hooks Before Compiling Models</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#save-validate-hooks" class="sidebar-link">Save/Validate Hooks</a></li></ul></li><li><a href="/guides/schema.html#plugins" class="sidebar-link">Plugins</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guides/schema.html#plugin-example" class="sidebar-link">Plugin Example</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#global-plugins" class="sidebar-link">Global Plugins</a></li></ul></li><li><a href="/guides/schema.html#strict-mode" class="sidebar-link">Strict Mode</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/guides/schema.html#schema-helpful-methods" class="sidebar-link">Schema Helpful Methods</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guides/schema.html#cast-method" class="sidebar-link">Cast method</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#validate-method" class="sidebar-link">Validate method</a></li></ul></li><li><a href="/guides/schema.html#next-up" class="sidebar-link">Next Up</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="schema"><a href="#schema" class="header-anchor">#</a> Schema</h1> <p>Schema maps to a Couchbase collection and defines the shape of the documents within that collection.</p> <p><img src="/assets/img/howToUse.c6f255a6.jpg" alt="How to Use"></p> <h2 id="defining-your-schema"><a href="#defining-your-schema" class="header-anchor">#</a> Defining your schema</h2> <p>Everything in Ottoman starts with a Schema.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> blogSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  title<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> String<span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  author<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token comment">// String is shorthand for {type: String},</span>
  authorNative<span class="token operator">:</span> Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>String<span class="token punctuation">,</span>
  body<span class="token operator">:</span> String<span class="token punctuation">,</span>
  comments<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> body<span class="token operator">:</span> String<span class="token punctuation">,</span> date<span class="token operator">:</span> Date <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  date<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> Date<span class="token punctuation">,</span> <span class="token keyword">default</span><span class="token operator">:</span> Date<span class="token punctuation">.</span>now <span class="token punctuation">}</span><span class="token punctuation">,</span>
  hidden<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
  status<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token keyword">enum</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Close'</span><span class="token punctuation">,</span> <span class="token string">'Open'</span><span class="token punctuation">,</span> <span class="token string">'Review'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  meta<span class="token operator">:</span> <span class="token punctuation">{</span>
    votes<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> Number<span class="token punctuation">,</span> min<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> max<span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    favs<span class="token operator">:</span> Number<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mixedObject<span class="token operator">:</span> Object<span class="token punctuation">,</span>
  mixedNative<span class="token operator">:</span> Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>Mixed<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>For more information about options, please <a href="/guides/schema.html#allowed-schematypes-are">review the types </a></p> <p>Each key in our code blogSchema defines a property in our documents which will be cast to its associated SchemaType. For example, we've defined a property title which will be casted to the String SchemaType and property date which will be casted to a Date SchemaType.</p> <p>Please note above that if a property only requires a type, it can be specified using a shorthand notation (contrast the title property above with the date property).</p> <p>Keys may also be assigned to nested objects containing further key/type definitions like the meta property above.
This will happen whenever a key's value is a POJO that lacks a bona-fide type property.
In these cases, only the leaves in a tree are given actual paths in the schema (like meta.votes and meta.favs above), and the branches do not have actual paths.
A side-effect of this is that meta above cannot have its own validation. If validation is needed up the tree, a path needs to be created up the tree.</p> <h2 id="allowed-schematypes-are"><a href="#allowed-schematypes-are" class="header-anchor">#</a> Allowed SchemaTypes are:</h2> <ul><li><a href="/classes/stringtype">String</a></li> <li><a href="/classes/numbertype">Number</a></li> <li><a href="/classes/booleantype">Boolean</a></li> <li><a href="/classes/datetype">Date</a></li> <li><a href="/classes/arraytype">Array</a></li> <li><a href="/classes/embedtype">Embed</a></li> <li><a href="/classes/referencetype">Reference</a></li> <li><a href="/classes/mixedtype">Mixed</a></li></ul> <p>Schemas not only define the structure of your document and casting of properties,
they also define document instance methods, static Model methods,
compound indexes, plugins and document lifecycle hooks.</p> <h2 id="creating-a-model"><a href="#creating-a-model" class="header-anchor">#</a> Creating a model</h2> <p>To use our schema definition, we need to convert our blogSchema into a Model we can work with.
To do so, we pass it into <code>model(modelName, schema)</code>:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Blog <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Blog'</span><span class="token punctuation">,</span> blogSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ready to go!</span>
</code></pre></div><h2 id="indexes"><a href="#indexes" class="header-anchor">#</a> Indexes</h2> <p>You can specify several indexes on a model. There are different kinds of indexes, each with its own benefits and restrictions.</p> <p>To specify indexes on a <a href="/guides/schema">Schema</a>, use the index key on the schema:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Schema <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ottoman'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  email<span class="token operator">:</span> String<span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token punctuation">{</span>
    first<span class="token operator">:</span> String<span class="token punctuation">,</span>
    last<span class="token operator">:</span> String<span class="token punctuation">,</span>
    full<span class="token operator">:</span> String<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

schema<span class="token punctuation">.</span>index<span class="token punctuation">.</span>findByEmail <span class="token operator">=</span> <span class="token punctuation">{</span>
  by<span class="token operator">:</span> <span class="token string">'email'</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">'refdoc'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

schema<span class="token punctuation">.</span>index<span class="token punctuation">.</span>findByFirstName <span class="token operator">=</span> <span class="token punctuation">{</span>
  by<span class="token operator">:</span> <span class="token string">'name.first'</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">'view'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

schema<span class="token punctuation">.</span>index<span class="token punctuation">.</span>findByLastName <span class="token operator">=</span> <span class="token punctuation">{</span>
  by<span class="token operator">:</span> <span class="token string">'name.last'</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">'n1ql'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>To ensure that server is working, you must call the <code>start</code> method.
This method will internally generate a list of indexes and scopes, collections (if you have the developer preview active)
which will be used with the most optimal configuration for them and will build the structures that might be missing on the server.
This method must be called after all models are defined, and it is a good idea to call this only when needed rather than any time your server is started.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// index.js</span>
<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> start <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ottoman'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserRoutes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./users/users.controller'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> UserRoutes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> useCollections <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// set this to true to create scopes/collections.</span>
<span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span> useCollections <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Ottoman is ready!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="index-types"><a href="#index-types" class="header-anchor">#</a> Index Types</h2> <p>Below are some quick notes on the types of indexes available, and their pros and cons. For a more in-depth discussion, consider
reading <a href="https://blog.couchbase.com/determine-data-access-in-couchbase/" target="_blank" rel="noopener noreferrer">Couchbasics: How Functional and Performance Needs Determine Data Access in Couchbase<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="refdoc"><a href="#refdoc" class="header-anchor">#</a> <code>refdoc</code></h3> <p>These indexes are the most performant, but the least flexible. They allow only a single document to occupy any particular value and do direct key-value lookups using a referential document to identify a matching document in Couchbase.</p> <p>In short, if you need to look up a document by a single value of a single attribute quickly (e.g. key lookups), this is the way to go. But you cannot combine multiple refdoc indexes to speed up finding
something like &quot;all customers with first name 'John' last name 'Smith'&quot;.</p> <h3 id="view"><a href="#view" class="header-anchor">#</a> <code>view</code></h3> <p>These indexes are the default and use map-reduce views. This type of index is always available once <code>ensureIndexes</code> is called and will work with any Couchbase Server version.</p> <p>Because views use map-reduce, certain types of queries can be faster as the query can be parallelized over all nodes in the cluster, with each node
returning only partial results. One of the cons of views is that they are eventually consistent by default, and incur a performance
penalty if you want consistency in the result.</p> <h3 id="n1ql"><a href="#n1ql" class="header-anchor">#</a> <code>n1ql</code></h3> <p>These indexes uses the new SQL-like query language available from Couchbase Server 4.0.0. These indexes are more performant than views in many cases and are significantly more flexible, allowing even un-indexed searches.</p> <p>N1QL indexes in Ottoman use <a href="http://developer.couchbase.com/documentation/server/current/indexes/gsi-for-n1ql.html" target="_blank" rel="noopener noreferrer">Couchbase GSIs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. If you need flexibility of queries and
speed, this is the way to go.</p> <h2 id="instance-methods"><a href="#instance-methods" class="header-anchor">#</a> Instance methods</h2> <p>Instances of Models are <a href="/guides/document.html">documents</a>. Documents have many of their own built-in instance methods.
We may also define our own custom document instance methods.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> connect<span class="token punctuation">,</span> Schema <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ottoman'</span><span class="token punctuation">;</span>
<span class="token comment">// connecting</span>
<span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'couchbase://localhost/travel-sample@admin:password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// define a schema</span>
<span class="token keyword">const</span> animalSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> String<span class="token punctuation">,</span> type<span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// assign a function to the &quot;methods&quot; object of our animalSchema</span>
animalSchema<span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function-variable function">findSimilarTypes</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">getModel</span><span class="token punctuation">(</span><span class="token string">'Animal'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Now all of our animal instances have a findSimilarTypes method available to them.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Animal <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Animal'</span><span class="token punctuation">,</span> animalSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'dog'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> dogs <span class="token operator">=</span> <span class="token keyword">await</span> dog<span class="token punctuation">.</span><span class="token function">findSimilarTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dogs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>Overwriting a default Ottoman document method may lead to unpredictable results.</li> <li>The example above uses the Schema.methods object directly to save an instance method.</li> <li>Do not declare methods using ES6 arrow functions (=&gt;). Arrow functions explicitly prevent binding this, so your method will not have access to the document and the above examples will not work.</li></ul> <h2 id="statics"><a href="#statics" class="header-anchor">#</a> Statics</h2> <p>You can also add static functions to your model.</p> <p>Add a function property to schema.statics
Call the Schema#static() function</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Assign a function to the &quot;statics&quot; object of our animalSchema</span>
animalSchema<span class="token punctuation">.</span>statics<span class="token punctuation">.</span><span class="token function-variable function">findByName</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Animal <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Animal'</span><span class="token punctuation">,</span> animalSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> animals <span class="token operator">=</span> <span class="token keyword">await</span> Animal<span class="token punctuation">.</span><span class="token function">findByName</span><span class="token punctuation">(</span><span class="token string">'fido'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Do <strong>not</strong> declare statics using ES6 arrow functions (=&gt;). Arrow functions explicitly prevent binding this,
so the above examples will not work because of the value of this.</p> <h2 id="hooks"><a href="#hooks" class="header-anchor">#</a> Hooks</h2> <p>Hooks are functions which are passed control during execution of asynchronous functions.
Hooks are specified at the schema level and are useful for writing plugins.</p> <h3 id="the-available-hooks-are"><a href="#the-available-hooks-are" class="header-anchor">#</a> The available hooks are:</h3> <ul><li><code>validate</code></li> <li><code>save</code></li> <li><code>update</code></li> <li><code>remove</code></li></ul> <h3 id="register-hooks-with-pre-function"><a href="#register-hooks-with-pre-function" class="header-anchor">#</a> Register hooks with <code>pre</code> function</h3> <p>Pre functions are executed one after another, for each hooks registered.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Schema<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ottoman'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">document</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// do stuff</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>You can use a function that returns a promise. In particular, you can use async/await.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">doStuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">doMoreStuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Or, in Node.js &gt;= 7.6.0:</span>
schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">doStuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">doMoreStuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="hooks-use-cases"><a href="#hooks-use-cases" class="header-anchor">#</a> Hooks Use Cases</h3> <p>Hooks are useful for atomizing model logic. Here we list some ideas:</p> <ul><li>complex validation</li> <li>removing dependent documents (removing a user removes all his blogposts)</li> <li>asynchronous defaults</li> <li>asynchronous tasks that a certain action triggers</li></ul> <h3 id="errors-in-pre-hooks"><a href="#errors-in-pre-hooks" class="header-anchor">#</a> Errors in Pre Hooks</h3> <p>If any pre hook errors out, Ottoman will not execute subsequent hooks or the hooked function.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// You can also return a promise that rejects</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'something went wrong'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// You can also throw a synchronous error</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'something went wrong'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// You can also throw an error in an `async` function</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'something went wrong'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// later...</span>

<span class="token comment">// Changes will not be persisted to Couchbase Server because a pre hook errored out</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> myDoc<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// something went wrong</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="post-hooks"><a href="#post-hooks" class="header-anchor">#</a> Post Hooks</h3> <p><code>post</code> middleware are executed after the hooked method and all of its pre hooks have completed.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>schema<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'validate'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%s has been validated (but not saved yet)'</span><span class="token punctuation">,</span> doc<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schema<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%s has been saved'</span><span class="token punctuation">,</span> doc<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schema<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'remove'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%s has been removed'</span><span class="token punctuation">,</span> doc<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="define-hooks-before-compiling-models"><a href="#define-hooks-before-compiling-models" class="header-anchor">#</a> Define Hooks Before Compiling Models</h3> <p>Calling <code>pre()</code> or <code>post()</code> after compiling a model does not work in Ottoman in general. For example, the below <code>pre('save')</code> hook will not fire.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Compile a model from the schema</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> schema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Ottoman will **not** call the middleware function, because</span>
<span class="token comment">// this hook was defined after the model was compiled</span>
schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello from pre save'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'test'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="save-validate-hooks"><a href="#save-validate-hooks" class="header-anchor">#</a> Save/Validate Hooks</h3> <p>The <code>save()</code> function triggers <code>validate()</code> hooks, because Ottoman has a built-in <code>pre('save')</code> hook that calls <code>validate()</code>.
This means that all <code>pre('validate')</code> and <code>post('validate')</code> hooks get called before any <code>pre('save')</code> hooks.
The <code>updateById()</code> function have the same behavior.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'validate'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this gets printed first'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schema<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'validate'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this gets printed second'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this gets printed third'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schema<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this gets printed fourth'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="plugins"><a href="#plugins" class="header-anchor">#</a> Plugins</h2> <p>Schemas are pluggable, that is, they allow for applying pre-packaged capabilities to extend their functionality. This is a very powerful feature.</p> <h3 id="plugin-example"><a href="#plugin-example" class="header-anchor">#</a> Plugin Example</h3> <p>Plugins are a tool for reusing logic in multiple schemas.
Suppose you have several models in your database and want to add a function to log all doc before save.
Just create a plugin once and apply it to each Schema using the <code>plugin</code> function:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">pluginLog</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">schema</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> UserSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  isActive<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
  name<span class="token operator">:</span> String
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

UserSchema<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span>pluginLog<span class="token punctuation">)</span>

<span class="token keyword">const</span> UserModel <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> UserSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserModel</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Pre save hooks will be execute and it will print the document just before save it to Couchbase server.</span>
<span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="global-plugins"><a href="#global-plugins" class="header-anchor">#</a> Global Plugins</h3> <p>Want to register a plugin for all schemas? The Ottoman <code>registerGlobalPlugin</code> function registers a plugin for every schema. For example:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>registerGlobalPlugin<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ottoman'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">pluginLog</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">schema</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">registerGlobalPlugin</span><span class="token punctuation">(</span>pluginLog<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> UserSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  isActive<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
  name<span class="token operator">:</span> String
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> UserModel <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> UserSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserModel</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Pre save hooks will be execute and it will log the document just before save it to Couchbase server.</span>
<span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="strict-mode"><a href="#strict-mode" class="header-anchor">#</a> Strict Mode</h2> <p>The strict option, (enabled by default),
ensures that values passed to our model constructor that were not specified in our schema do not get saved to the db.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> userSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> userSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">{</span> iAmNotInTheSchema<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// iAmNotInTheSchema is not saved to the db</span>

<span class="token comment">// set to false..</span>
<span class="token keyword">const</span> userSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> strict<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">{</span> iAmNotInTheSchema<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// iAmNotInTheSchema is now saved to the db!!</span>
</code></pre></div><p>This value can be overridden at the model instance level by passing as second argument:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> userSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> <span class="token punctuation">{</span> strict<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// enables strict mode</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> <span class="token punctuation">{</span> strict<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// disables strict mode</span>
</code></pre></div><h2 id="schema-helpful-methods"><a href="#schema-helpful-methods" class="header-anchor">#</a> Schema Helpful Methods</h2> <p>Each <code>Schema</code> instance have two helpful methods <code>cast</code> and <code>validate</code>.</p> <h3 id="cast-method"><a href="#cast-method" class="header-anchor">#</a> Cast method</h3> <p>The <code>cast</code> method get a Javascript Object as first parameter and enforce schema types for each field in the schema definition.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> String<span class="token punctuation">,</span>
    price<span class="token operator">:</span> Number<span class="token punctuation">,</span>
    createdAt<span class="token operator">:</span> Date
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> schema<span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'TV'</span><span class="token punctuation">,</span>
    price<span class="token operator">:</span> <span class="token string">'345.99'</span><span class="token punctuation">,</span>
    createdAt<span class="token operator">:</span> <span class="token string">'2020-12-20T16:00:00.000Z'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// result variable now look like this:</span>
<span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'TV'</span><span class="token punctuation">,</span>
    price<span class="token operator">:</span> <span class="token number">345.99</span><span class="token punctuation">,</span> <span class="token comment">// price was casted to Number</span>
    createdAt<span class="token operator">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">20</span>T16<span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00.000</span>Z <span class="token comment">//createdAt was casted to Date</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="cast-method-options"><a href="#cast-method-options" class="header-anchor">#</a> Cast method options</h4> <p><code>cast</code> method have a few useful options:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">CastOptions</span> <span class="token punctuation">{</span>
  strict<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  skip<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  strategy<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">CAST_STRATEGY</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>strict</code> will remove field not defined in the schema. The default value is set to true.</li> <li><code>skip</code> will be a string array with values of the key you may want to prevent to cast. The default value is empty [].</li> <li><code>strategy</code> when cast action fail, defined strategy is apply. The default strategy is set to <code>defaultOrDrop</code></li></ul> <p>Available strategies are:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token constant">CAST_STRATEGY</span>
<span class="token punctuation">{</span>
  <span class="token constant">KEEP</span> <span class="token operator">=</span> <span class="token string">'keep'</span><span class="token punctuation">,</span> <span class="token comment">// will return original value</span>
    drop <span class="token operator">=</span> <span class="token string">'DROP'</span><span class="token punctuation">,</span> <span class="token comment">// will remove the field</span>
    <span class="token constant">THROW</span> <span class="token operator">=</span> <span class="token string">'throw'</span><span class="token punctuation">,</span> <span class="token comment">// will throw an exception</span>
    <span class="token constant">DEFAULT_OR_DROP</span> <span class="token operator">=</span> <span class="token string">'defaultOrDrop'</span><span class="token punctuation">,</span> <span class="token comment">// use default or remove the field if no default was provided</span>
    <span class="token constant">DEFAULT_OR_KEEP</span> <span class="token operator">=</span> <span class="token string">'defaultOrKeep'</span><span class="token punctuation">,</span> <span class="token comment">// use default or return original value</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="validate-method"><a href="#validate-method" class="header-anchor">#</a> Validate method</h3> <p>The <code>validate</code> method get a Javascript Object as first parameter and enforce schema types, rules and validations for each field in the schema definition.
If something fail an exception will be throw up, else the <code>validate</code> method will return a valid object for the current Schema.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> String<span class="token punctuation">,</span>
    price<span class="token operator">:</span> Number<span class="token punctuation">,</span>
    createdAt<span class="token operator">:</span> Date
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> schema<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'TV'</span><span class="token punctuation">,</span>
    price<span class="token operator">:</span> <span class="token string">'345.99'</span><span class="token punctuation">,</span>
    createdAt<span class="token operator">:</span> <span class="token string">'2020-12-20T16:00:00.000Z'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// result variable now look like this:</span>
<span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'TV'</span><span class="token punctuation">,</span>
    price<span class="token operator">:</span> <span class="token number">345.99</span><span class="token punctuation">,</span> <span class="token comment">// price was casted to Number</span>
    createdAt<span class="token operator">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">20</span>T16<span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00.000</span>Z <span class="token comment">//createdAt was casted to Date</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="validate-method-options"><a href="#validate-method-options" class="header-anchor">#</a> Validate method options</h4> <p><code>validate</code> method have 1 options:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  strict<span class="token operator">:</span> boolean<span class="token punctuation">;</span> <span class="token comment">// strict set to true, will remove field not defined in the schema.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>By default, it will get the <code>strict</code> option value set via the Schema constructor.</p> <h2 id="next-up"><a href="#next-up" class="header-anchor">#</a> Next Up</h2> <p>Nice, now we'll can see how <a href="/guides/model">Models</a> works.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.4ce8c23d.js" defer></script><script src="/assets/js/2.3ccdf2b1.js" defer></script><script src="/assets/js/7.1fd01169.js" defer></script>
  </body>
</html>
